<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InovaApps · Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet">
</head>
<body class="app">
  <header class="brand-gradient py-3 text-white mb-3">
    <div class="container d-flex justify-content-between align-items-center p-0">
      <div class="d-flex align-items-center ms-2">
        <img src="./Fixtures/LogoUnita.avif" alt="Logo da Empresa" style="max-height:40px;">
      </div>
      <div class="text-center flex-grow-1">
        <span class="fs-4 fw-semibold text-white">Chatbot</span>
      </div>
      <div class="d-flex align-items-center me-2 gap-2">
        <a href="./chamados.html" class="btn btn-sm btn-outline-light">Chamados</a>
        <button class="btn btn-sm btn-outline-light" id="userBtn" data-bs-toggle="modal" data-bs-target="#userModal">Usuário</button>
        <button class="btn btn-sm btn-outline-light" id="newTicketBtn" data-bs-toggle="modal" data-bs-target="#newTicketModal">Novo Chamado</button>
        <span class="badge bg-light text-dark" id="modeBadge">Demo</span>
      </div>
    </div>
  </header>

  <main class="container chat-wrapper">
    <div class="card chat-card shadow-soft">
      <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <strong>Assistente</strong>
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted">Enter = enviar · Shift+Enter = nova linha</small>
          <button class="btn btn-sm btn-outline-secondary" id="settingsBtn" title="Configurações">⚙️</button>
        </div>
      </div>

      <div id="chatLog" class="chat-log">
        <div class="bubble-row bot">
          <div class="msg bot">
            <div><strong>Oi!</strong> Escreva seu problema. Se o backend estiver rodando, uso <b>Gemini</b>; se não, uso <b>Demo</b>.</div>
            <div class="meta">Assistente · agora</div>
          </div>
        </div>
      </div>

      <div class="chat-input p-3">
        <div class="d-flex gap-2">
          <textarea id="chatInput" class="form-control" rows="1" placeholder="Escreva aqui…"></textarea>
          <button id="sendBtn" class="btn btn-brand">Enviar</button>
        </div>
        <div class="form-text mt-2" id="modeHint">Respostas rápidas e objetivas.</div>
        <div id="typing" class="typing text-muted small mt-2">Assistente está digitando…</div>
      </div>
    </div>
    <div class="text-center my-3">
      <button id="testTicketBtn" class="btn btn-outline-primary">Gerar Chamado de Teste</button>
    </div>
    <script>
      document.getElementById('testTicketBtn').addEventListener('click', () => {
        // Função auxiliar para salvar ticket
        function ticketsLoad(){ try { return JSON.parse(localStorage.getItem('tickets')||'[]'); } catch { return []; } }
        function ticketsSave(list){ localStorage.setItem('tickets', JSON.stringify(list||[])); }
        function cap(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

        const list = ticketsLoad();
        const ticket = {
          id: Date.now(),
          name: 'Teste',
          title: 'Chamado de Teste',
          description: 'Este é um chamado gerado manualmente pelo botão de teste.',
          createdAt: new Date().toISOString()
        };
        list.unshift(ticket);
        ticketsSave(list);
        window.location.href = './chamados.html';
      });
    </script>
  </main>

  <!-- Modal Configurações -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="settingsLabel" class="modal-title">Configurações do Chat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            O chat tentará usar o <b>backend proxy</b> em <code>/api/gemini-chat</code>.<br>
            Se o backend não estiver disponível, cai em <b>Demo</b> automaticamente.
          </div>
          <div class="mb-3">
            <label class="form-label">Modelo</label>
            <select id="geminiModel" class="form-select">
              <option value="gemini-1.5-flash">gemini-1.5-flash (recomendado)</option>
              <option value="gemini-pro">gemini-pro (texto)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">URL do backend</label>
            <input id="backendUrl" type="text" class="form-control" placeholder="/api/gemini-chat">
            <div class="form-text">Use relativo (<code>/api/gemini-chat</code>) se o frontend for servido junto do backend.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="saveSettings" class="btn btn-brand">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Usuário -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="userLabel" class="modal-title">Perfil do Colaborador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="userName" class="form-label">Nome</label>
            <input type="text" id="userName" class="form-control" placeholder="Digite o nome do colaborador" />
          </div>
          <div class="mb-2">Setor (marque um ou mais):</div>
          <div class="row g-2">
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Suporte" id="setorSuporte">
                <label class="form-check-label" for="setorSuporte">Suporte</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Vendas" id="setorVendas">
                <label class="form-check-label" for="setorVendas">Vendas</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Financeiro" id="setorFinanceiro">
                <label class="form-check-label" for="setorFinanceiro">Financeiro</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="TI" id="setorTI">
                <label class="form-check-label" for="setorTI">TI</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="RH" id="setorRH">
                <label class="form-check-label" for="setorRH">RH</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="saveUser" class="btn btn-brand">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Novo Chamado (manual) -->
  <div class="modal fade" id="newTicketModal" tabindex="-1" aria-labelledby="newTicketLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="newTicketLabel" class="modal-title">Novo Chamado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="ticketTitle" class="form-label">Título</label>
            <input type="text" id="ticketTitle" class="form-control" placeholder="Ex.: Erro ao fazer login" />
          </div>
          <div class="mb-3">
            <label for="ticketDescription" class="form-label">Descrição</label>
            <textarea id="ticketDescription" class="form-control" rows="4" placeholder="Descreva o problema com detalhes…"></textarea>
          </div>

          <div class="mb-2">Departamento (marque um ou mais):</div>
          <div class="row g-2">
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="TI" id="deptTI">
                <label class="form-check-label" for="deptTI">TI</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Recursos Humanos" id="deptRH">
                <label class="form-check-label" for="deptRH">Recursos Humanos</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Financeiro" id="deptFin">
                <label class="form-check-label" for="deptFin">Financeiro</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Comercial" id="deptCom">
                <label class="form-check-label" for="deptCom">Comercial</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Marketing" id="deptMkt">
                <label class="form-check-label" for="deptMkt">Marketing</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Operações" id="deptOps">
                <label class="form-check-label" for="deptOps">Operações</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Outro" id="deptOut">
                <label class="form-check-label" for="deptOut">Outro</label>
              </div>
            </div>
          </div>

          <div class="form-text mt-2">Você poderá vincular esse chamado ao perfil do usuário depois.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="createTicket" class="btn btn-brand">Criar chamado</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./scripts.js"></script>
  <script>
    (function(){
      const KEY = 'userProfile';
      const $btn = document.getElementById('userBtn');
      const $name = document.getElementById('userName');
      const $save = document.getElementById('saveUser');
      const setorIds = ['setorSuporte','setorVendas','setorFinanceiro','setorTI','setorRH'];

      function loadProfile(){
        try { return JSON.parse(localStorage.getItem(KEY)||'{}'); } catch { return {}; }
      }
      function saveProfile(p){ localStorage.setItem(KEY, JSON.stringify(p||{})); }
      function firstName(full){ if(!full) return ''; return String(full).trim().split(/\s+/)[0]; }

      function updateButton(){
        const p = loadProfile();
        if (p && p.name) { $btn.textContent = firstName(p.name); }
        else { $btn.textContent = 'Usuário'; }
      }

      function populateModal(){
        const p = loadProfile();
        $name.value = p.name || '';
        const set = new Set(p.setores || []);
        setorIds.forEach(id => { const el = document.getElementById(id); if (el) el.checked = set.has(el.value); });
      }

      document.getElementById('userModal').addEventListener('show.bs.modal', populateModal);

      $save.addEventListener('click', () => {
        const setores = setorIds.map(id => document.getElementById(id)).filter(el => el && el.checked).map(el => el.value);
        const profile = { name: $name.value.trim(), setores };
        saveProfile(profile);
        updateButton();
        const modalEl = document.getElementById('userModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
      });

      // Init label on load
      updateButton();
    })();
  </script>
</body>
</html>